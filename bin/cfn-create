#! /usr/bin/env ruby

require 'aws-sdk'
require_relative '../lib/cfn-toolkit/stack_running_parser'

opts = opt_parser.parse(ARGV)

ARGV.replace opts.arguments

template = ARGF.read
client = Aws::CloudFormation::Client.new
id = client.create_stack(
  stack_name: ARGV.first,
  template_body: template,
  tags: opts[:tags],
  capabilities: ["CAPABILITY_IAM"],
  parameters: opts[:params].map do |p|
    { parameter_key: p[:key], parameter_value: p[:value], use_previous_value: true }
  end
).stack_id

client.wait_until(:stack_create_complete, stack_name: ARGV.first) do |waiter|
  waiter.before_wait do |attempts, response|
    puts "#{attempts} made"
    puts response.error.inspect
    puts response.data.inspect
  end
end
